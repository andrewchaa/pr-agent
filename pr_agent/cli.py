"""
CLI interface for pr-agent.

Main command-line interface that orchestrates PR creation workflow.
"""

import sys
from pathlib import Path
from typing import Optional

import click
from rich.console import Console
from rich.panel import Panel
from rich.prompt import Prompt, Confirm
from rich.markdown import Markdown
from rich import print as rprint

from pr_agent.config import load_config, Config
from pr_agent.git_operations import GitOperations
from pr_agent.github_operations import GitHubOperations
from pr_agent.llm_client import OllamaClient
from pr_agent.pr_generator import PRGenerator
from pr_agent.exceptions import (
    PRAgentError,
    NotInGitRepoError,
    NotAuthenticatedError,
    OllamaNotAvailableError,
    ModelNotFoundError,
    NoChangesError,
    GitError,
    LLMError,
)

console = Console()


def validate_prerequisites(
    git_ops: GitOperations,
    github_ops: GitHubOperations,
    llm_client: OllamaClient,
    model: str,
) -> bool:
    """
    Validate all prerequisites for PR creation.

    Args:
        git_ops: Git operations handler
        github_ops: GitHub operations handler
        llm_client: Ollama client
        model: Model name to check

    Returns:
        True if all checks pass.

    Raises:
        PRAgentError: If any prerequisite check fails.
    """
    console.print("[bold blue]Validating prerequisites...[/bold blue]")

    # Check 1: Git repository
    try:
        git_ops.validate_git_repo()
        console.print("✓ Git repository detected", style="green")
    except NotInGitRepoError as e:
        console.print(f"✗ {e}", style="red")
        raise

    # Check 2: GitHub CLI authentication
    try:
        github_ops.check_gh_auth()
        console.print("✓ GitHub CLI authenticated", style="green")
    except NotAuthenticatedError as e:
        console.print(f"✗ {e}", style="red")
        raise

    # Check 3: Ollama service
    try:
        llm_client.check_availability()
        console.print("✓ Ollama service available", style="green")
    except OllamaNotAvailableError as e:
        console.print(f"✗ {e}", style="red")
        raise

    # Check 4: Model availability
    try:
        llm_client.check_model_exists(model)
        console.print(f"✓ Model '{model}' available", style="green")
    except ModelNotFoundError as e:
        console.print(f"✗ {e}", style="red")
        raise

    console.print()
    return True


def get_ticket_number(
    git_ops: GitOperations,
    config: Config,
    llm_client: Optional[OllamaClient] = None,
) -> str:
    """
    Extract or prompt for ticket number.

    Tries multiple methods in order:
    1. Regex pattern matching (fast)
    2. LLM extraction (flexible, handles variations)
    3. Manual user input (fallback)

    Args:
        git_ops: Git operations handler
        config: Configuration
        llm_client: Optional LLM client for intelligent extraction

    Returns:
        Ticket number.
    """
    branch_name = git_ops.get_current_branch()

    # Method 1: Try regex extraction first (fast)
    ticket_number = git_ops.extract_ticket_number(branch_name, config.ticket_pattern)

    if ticket_number:
        console.print(f"[green]✓ Detected ticket number (regex):[/green] {ticket_number}")
        return ticket_number

    # Method 2: Try LLM extraction (handles variations)
    if llm_client:
        console.print(
            f"[yellow]Regex pattern didn't match. Trying AI extraction...[/yellow]"
        )
        try:
            # Extract ticket prefix from pattern (e.g., "STAR-(\d+)" -> "STAR")
            import re
            pattern_match = re.match(r"([A-Z]+)-", config.ticket_pattern)
            ticket_prefix = pattern_match.group(1) if pattern_match else "STAR"

            with console.status("[bold cyan]Analyzing branch name with AI...[/bold cyan]"):
                ticket_number = llm_client.extract_ticket_number(
                    branch_name=branch_name,
                    ticket_prefix=ticket_prefix,
                    model=config.model,
                )

            if ticket_number:
                console.print(f"[green]✓ Detected ticket number (AI):[/green] {ticket_number}")
                return ticket_number
        except Exception as e:
            console.print(f"[yellow]AI extraction failed: {e}[/yellow]")

    # Method 3: Manual input (fallback)
    console.print(
        f"[yellow]Could not extract ticket number from branch '{branch_name}'[/yellow]"
    )
    ticket_number = Prompt.ask(
        "Please enter ticket number (e.g., STAR-12345)",
        default="STAR-0000"
    )
    return ticket_number


def prompt_user_intent() -> str:
    """
    Prompt user for the purpose of their change.

    Returns:
        User's description of the change purpose.
    """
    console.print()
    console.print("[bold cyan]What is the purpose of this change?[/bold cyan]")
    console.print("[dim]Describe what you're trying to achieve (this helps generate better PR descriptions)[/dim]")
    console.print()

    user_intent = Prompt.ask("Purpose")

    while not user_intent.strip():
        console.print("[red]Please provide a description of your changes.[/red]")
        user_intent = Prompt.ask("Purpose")

    return user_intent.strip()


def display_preview(title: str, body: str, base_branch: str) -> None:
    """
    Display PR preview with Rich formatting.

    Args:
        title: PR title
        body: PR description
        base_branch: Base branch name
    """
    console.print()
    console.print("[bold green]PR Preview:[/bold green]")
    console.print()

    # Display title
    console.print(Panel(
        f"[bold]{title}[/bold]",
        title="Title",
        border_style="cyan"
    ))

    # Display base branch
    console.print(f"[dim]Base branch:[/dim] {base_branch}")
    console.print()

    # Display body
    md = Markdown(body)
    console.print(Panel(
        md,
        title="Description",
        border_style="cyan"
    ))
    console.print()


@click.group()
@click.version_option(version="0.1.0")
def cli():
    """PR Agent - Automated GitHub PR creation using local LLM."""
    pass


@cli.command()
@click.option(
    "--base-branch", "-b",
    default=None,
    help="Base branch for the PR (default: from config or 'main')"
)
@click.option(
    "--model", "-m",
    default=None,
    help="LLM model to use (default: from config or 'qwen2.5:3b')"
)
@click.option(
    "--config", "-c",
    type=click.Path(exists=True, path_type=Path),
    default=None,
    help="Path to config file (default: ~/.config/pr-agent/config.yaml)"
)
@click.option(
    "--draft", "-d",
    is_flag=True,
    help="Create as draft PR"
)
@click.option(
    "--web", "-w",
    is_flag=True,
    help="Open PR in browser after creation"
)
@click.option(
    "--dry-run",
    is_flag=True,
    help="Preview PR without creating it"
)
def create(
    base_branch: Optional[str],
    model: Optional[str],
    config: Optional[Path],
    draft: bool,
    web: bool,
    dry_run: bool,
):
    """Create a new pull request with AI-generated description."""
    try:
        # Load configuration
        cfg = load_config(
            config_file=config,
            base_branch=base_branch,
            model=model,
            draft=draft,
            web=web,
        )

        # Initialize components
        git_ops = GitOperations()
        github_ops = GitHubOperations()
        llm_client = OllamaClient(
            base_url=cfg.ollama_base_url,
            timeout=cfg.ollama_timeout
        )

        # Validate prerequisites
        validate_prerequisites(git_ops, github_ops, llm_client, cfg.model)

        # Auto-detect base branch if not explicitly set
        if not base_branch:  # Only auto-detect if user didn't specify
            detected_base = git_ops.get_default_branch()
            if detected_base and detected_base != cfg.default_base_branch:
                console.print(
                    f"[cyan]Auto-detected base branch:[/cyan] {detected_base} "
                    f"[dim](instead of default '{cfg.default_base_branch}')[/dim]"
                )
                cfg.default_base_branch = detected_base
            elif not git_ops.branch_exists(cfg.default_base_branch):
                # Config default doesn't exist, try to find one
                if detected_base:
                    console.print(
                        f"[yellow]Base branch '{cfg.default_base_branch}' not found. "
                        f"Using '{detected_base}' instead.[/yellow]"
                    )
                    cfg.default_base_branch = detected_base

        # Get branch and ticket information
        branch_name = git_ops.get_current_branch()
        console.print(f"[blue]Current branch:[/blue] {branch_name}")
        console.print()

        ticket_number = get_ticket_number(git_ops, cfg, llm_client)

        # Check for uncommitted changes
        if git_ops.has_uncommitted_changes():
            console.print(
                "[yellow]You have uncommitted changes.[/yellow]"
            )
            console.print()

            # Offer to commit changes
            if Confirm.ask("Would you like me to commit these changes?", default=True):
                try:
                    # Get uncommitted changes info
                    diff = git_ops.get_uncommitted_diff()
                    changed_files = git_ops.repo.git.diff('HEAD', name_only=True).strip().split('\n')
                    changed_files = [f for f in changed_files if f]  # Filter empty

                    if not changed_files:
                        console.print("[yellow]No files to commit.[/yellow]")
                    else:
                        # Generate commit message
                        console.print()
                        with console.status("[bold cyan]Generating commit message with AI...[/bold cyan]"):
                            commit_message = llm_client.generate_commit_message(
                                ticket_number=ticket_number,
                                changed_files=changed_files,
                                diff=diff,
                                model=cfg.model,
                            )

                        # Display and confirm
                        console.print()
                        console.print("[cyan]Suggested commit message:[/cyan]")
                        console.print(f"  {commit_message}")
                        console.print()

                        if Confirm.ask("Use this commit message?", default=True):
                            with console.status("[bold green]Committing changes...[/bold green]"):
                                git_ops.stage_all_changes()
                                git_ops.create_commit(commit_message)
                            console.print("[green]✓ Changes committed successfully[/green]")
                            console.print()
                        else:
                            # User rejected message, ask if they want to continue without committing
                            console.print("[yellow]Commit cancelled.[/yellow]")
                            if not Confirm.ask("Continue without committing?", default=False):
                                console.print("[red]Aborted.[/red]")
                                sys.exit(0)
                except (GitError, LLMError) as e:
                    console.print(f"[red]Error during auto-commit: {e}[/red]")
                    console.print()
                    if not Confirm.ask("Continue without committing?", default=False):
                        console.print("[red]Aborted.[/red]")
                        sys.exit(0)
            else:
                # User doesn't want to commit
                if not Confirm.ask("Continue without committing?", default=False):
                    console.print("[red]Aborted.[/red]")
                    sys.exit(0)

        # Check if there are commits to create PR for
        commit_count = git_ops.get_commit_count(cfg.default_base_branch)

        if commit_count == 0:
            console.print(
                f"[red]No commits found on '{branch_name}' compared to '{cfg.default_base_branch}'.[/red]"
            )
            console.print()
            console.print("This could mean:")
            console.print("  • You're on the base branch itself")
            console.print("  • Your changes haven't been committed yet")
            console.print("  • Your branch is already merged")
            console.print()
            console.print("To create a PR, you need to:")
            console.print("  1. Make some changes")
            console.print("  2. Commit them: [cyan]git add . && git commit -m 'your message'[/cyan]")
            console.print(f"  3. Make sure you're not on '{cfg.default_base_branch}'")
            sys.exit(1)

        console.print(f"[green]✓ Found {commit_count} commit(s) to include in PR[/green]")
        console.print()

        # Prompt for user intent
        user_intent = prompt_user_intent()

        # Generate PR content
        console.print()
        with console.status("[bold green]Generating PR description with AI...[/bold green]"):
            pr_generator = PRGenerator(
                llm_client=llm_client,
                git_ops=git_ops,
                model=cfg.model,
                max_diff_tokens=cfg.max_diff_tokens,
                repo_path=str(git_ops.get_repository_root()),
            )

            # Generate title
            title = pr_generator.generate_title(
                ticket_number=ticket_number,
                branch_name=branch_name,
                user_intent=user_intent,
            )

            # Generate description
            description = pr_generator.generate_description(
                user_intent=user_intent,
                base_branch=cfg.default_base_branch,
            )

        # Display preview
        display_preview(title, description, cfg.default_base_branch)

        # Dry run mode - exit here
        if dry_run:
            console.print("[yellow]Dry run mode - PR not created[/yellow]")
            sys.exit(0)

        # Confirm creation
        if not Confirm.ask("Create this pull request?", default=True):
            console.print("[yellow]PR creation cancelled.[/yellow]")
            sys.exit(0)

        # Check if branch is pushed to remote
        console.print()
        if not github_ops.check_remote_branch_exists(branch_name):
            console.print("[yellow]Branch not pushed to remote yet.[/yellow]")
            if Confirm.ask("Push branch now?", default=True):
                with console.status("[bold green]Pushing branch...[/bold green]"):
                    github_ops.push_current_branch()
                console.print("[green]✓ Branch pushed successfully[/green]")
            else:
                console.print("[red]Cannot create PR without pushing branch first.[/red]")
                sys.exit(1)

        # Create PR
        console.print()
        with console.status("[bold green]Creating pull request...[/bold green]"):
            pr_url = github_ops.create_pull_request(
                title=title,
                body=description,
                base=cfg.default_base_branch,
                draft=cfg.draft_pr,
                web=cfg.open_in_browser,
            )

        # Success!
        console.print()
        console.print("[bold green]✓ Pull request created successfully![/bold green]")
        console.print(f"[blue]URL:[/blue] {pr_url}")

    except PRAgentError as e:
        console.print(f"\n[red]Error:[/red] {e}")
        sys.exit(1)
    except KeyboardInterrupt:
        console.print("\n[yellow]Cancelled by user.[/yellow]")
        sys.exit(130)
    except Exception as e:
        console.print(f"\n[red]Unexpected error:[/red] {e}")
        if "--debug" in sys.argv:
            raise
        sys.exit(1)


@cli.command()
def init_config():
    """Create a default configuration file."""
    try:
        config_path = Config.create_default_config_file()
        console.print(f"[green]✓ Created default config file at:[/green] {config_path}")
        console.print()
        console.print("[dim]Edit this file to customize pr-agent settings.[/dim]")
    except Exception as e:
        console.print(f"[red]Failed to create config file:[/red] {e}")
        sys.exit(1)


def main():
    """Main entry point for CLI."""
    cli()


if __name__ == "__main__":
    main()
